<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>cubeb</title>
<link rel="stylesheet" href="https://stackedit.io/res-min/themes/base.css" />
<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body><div class="container"><h1 id="cubeb">Cubeb</h1>

<p><a href="https://github.com/kinetiknz/cubeb" title="cubeb">cubeb</a> is cross platform audio library supporting linux, OS X, windows, and android. Here is <a href="https://github.com/ChunMinChang/cubeb" title="cubeb">my repo</a>.</p>



<h2 id="how-cubeb-works">How cubeb works</h2>

<p><a href="https://github.com/kinetiknz/cubeb" title="cubeb">cubeb</a> provides an <strong>uniform interface</strong> like <code>cubeb_init</code>, <code>cubeb_stream_init</code>, <code>cubeb_stream_start</code>, or <code>cubeb_stream_stop</code> on each platform.</p>



<h2 id="cubeb-inside">Cubeb Inside</h2>



<h3 id="what-is-the-relationship-between-gecko-and-cubeb">What is the relationship between Gecko and cubeb</h3>

<p><a href="https://github.com/kinetiknz/cubeb" title="cubeb">cubeb</a> is imported into <a href="https://github.com/mozilla/gecko-dev" title="Mozilla Gecko">Gecko</a> as a library, named <a href="http://searchfox.org/mozilla-central/source/media/libcubeb" title="libcubeb">libcubeb</a>. It will be updated periodically.</p>



<h3 id="where-is-the-entry-point-from-gecko-to-cubeb">Where is the entry point from Gecko to cubeb</h3>

<p><a href="https://github.com/mozilla/gecko-dev" title="Mozilla Gecko">Gecko</a> uses <a href="http://searchfox.org/mozilla-central/source/dom/media/CubebUtils.h" title="CubebUtils.h">CubebUtils</a> to wrap <a href="http://searchfox.org/mozilla-central/source/media/libcubeb" title="libcubeb">cubeb library(libcubeb)</a>, and the entry point to creates a cubeb object is in <a href="http://searchfox.org/mozilla-central/rev/d96317a351af8aa78ab9847e7feed964bbaac7d7/dom/media/AudioStream.cpp#350" title="cubeb context in AudioStream">AudioStream::Init</a>, where <a href="http://searchfox.org/mozilla-central/rev/d96317a351af8aa78ab9847e7feed964bbaac7d7/dom/media/CubebUtils.cpp#142">CubebUtils::GetCubebContext</a> is fired to call <a href="http://searchfox.org/mozilla-central/rev/d96317a351af8aa78ab9847e7feed964bbaac7d7/dom/media/CubebUtils.cpp#215">GetCubebContextUnlocked</a> to <a href="http://searchfox.org/mozilla-central/rev/d96317a351af8aa78ab9847e7feed964bbaac7d7/media/libcubeb/src/cubeb.c#111">initialize the cubeb</a>.</p>

<p><a href="http://searchfox.org/mozilla-central/rev/d96317a351af8aa78ab9847e7feed964bbaac7d7/dom/media/AudioStream.cpp#357">AudioStream::Init</a> will return <a href="http://searchfox.org/mozilla-central/rev/d96317a351af8aa78ab9847e7feed964bbaac7d7/dom/media/AudioStream.cpp#361">OpenCubeb</a>, which takes the cubeb object created from  <a href="http://searchfox.org/mozilla-central/rev/d96317a351af8aa78ab9847e7feed964bbaac7d7/dom/media/AudioStream.cpp#350" title="cubeb context in AudioStream">cubeb_init</a> as a parameter, and <a href="http://searchfox.org/mozilla-central/rev/d96317a351af8aa78ab9847e7feed964bbaac7d7/dom/media/AudioStream.cpp#370">OpenCubeb</a> will call <a href="http://searchfox.org/mozilla-central/rev/d96317a351af8aa78ab9847e7feed964bbaac7d7/media/libcubeb/include/cubeb.h#419">cubeb_stream_init</a> to initialize the <a href="http://searchfox.org/mozilla-central/rev/d96317a351af8aa78ab9847e7feed964bbaac7d7/media/libcubeb/include/cubeb.h#120">cubeb_stream</a> and <a href="http://searchfox.org/mozilla-central/rev/d96317a351af8aa78ab9847e7feed964bbaac7d7/dom/media/AudioStream.cpp#374">save it as its member</a>.</p>



<h4 id="why-we-only-use-cubebstream-as-member-in-audiostream">Why we only use <code>cubeb_stream</code> as member in <code>AudioStream</code>?</h4>

<p>One of a member of <code>AudioStream</code> is a <a href="http://searchfox.org/mozilla-central/rev/d96317a351af8aa78ab9847e7feed964bbaac7d7/dom/media/AudioStream.h#290">unique pointer to <code>cubeb_stream</code></a>. But, don’t we need to track the <a href="http://searchfox.org/mozilla-central/rev/d96317a351af8aa78ab9847e7feed964bbaac7d7/dom/media/AudioStream.cpp#350" title="cubeb context in AudioStream">created cubeb object</a> in <code>AudioStream::Init</code>? Why don’t we use <code>cubeb</code> as member instead of using <code>cubeb_stream</code> in <code>AudioStream</code>?</p>

<p>The truth is that the <a href="http://searchfox.org/mozilla-central/rev/d96317a351af8aa78ab9847e7feed964bbaac7d7/dom/media/AudioStream.cpp#350" title="cubeb context in AudioStream">created cubeb object</a> is <strong>still kept tracking</strong>. The <code>cubeb_stream</code> has a <a href="http://searchfox.org/mozilla-central/rev/d96317a351af8aa78ab9847e7feed964bbaac7d7/media/libcubeb/src/cubeb.c#24">pointer to <code>cubeb</code></a>, so it still can be found!</p>

<p>The <code>cubeb_stream-&gt;context</code> will be set in <code>cubeb_stream_init</code>. You can check its code on each platform:</p>

<ul>
<li><code>cubeb_stream_init</code> on <a href="http://searchfox.org/mozilla-central/rev/d96317a351af8aa78ab9847e7feed964bbaac7d7/media/libcubeb/src/cubeb_wasapi.cpp#1628">windows</a></li>
<li><code>cubeb_stream_init</code> on <a href="http://searchfox.org/mozilla-central/rev/d96317a351af8aa78ab9847e7feed964bbaac7d7/media/libcubeb/src/cubeb_audiounit.cpp#1142">OSX</a></li>
<li><code>cubeb_stream_init</code> on <a href="http://searchfox.org/mozilla-central/rev/d96317a351af8aa78ab9847e7feed964bbaac7d7/media/libcubeb/src/cubeb_pulse.c#729">Linux</a></li>
</ul>



<h3 id="how-sound-played-in-cubeb">How sound played in cubeb</h3>

<p>It depends. It has different mechanisms for each platform. Please refer to following topics:</p>

<ul>
<li>Windows: How sound played in WAS API</li>
<li>Linux: How sound played in PulseAudio</li>
<li>OS X: How sound played in AudioUnit</li>
</ul>



<h3 id="terms">Terms</h3>

<ul>
<li>capture stream: input stream</li>
<li>render stream: output stream</li>
<li>channel layout </li>
<li>channel order</li>
</ul>



<h2 id="multiple-channel">Multiple Channel</h2>

<p>To support multiple channels, we need to configure channel layout first.</p>



<h3 id="channel-layout">Channel layout</h3>

<p>Channel layout is a configuration specifying which channel will be used.</p>

<table>
<thead>
<tr>
  <th>label</th>
  <th>Channel name</th>
</tr>
</thead>
<tbody><tr>
  <td>FC</td>
  <td>Front Center</td>
</tr>
<tr>
  <td>FL</td>
  <td>Front Left</td>
</tr>
<tr>
  <td>FR</td>
  <td>Front Right</td>
</tr>
<tr>
  <td>LFE</td>
  <td>Low Frequency Effect</td>
</tr>
<tr>
  <td>BL</td>
  <td>Back Left</td>
</tr>
<tr>
  <td>BR</td>
  <td>Back Right</td>
</tr>
<tr>
  <td>BC</td>
  <td>Back Center</td>
</tr>
<tr>
  <td>SL</td>
  <td>Side Left</td>
</tr>
<tr>
  <td>SR</td>
  <td>Side Right</td>
</tr>
</tbody></table>


<p>The above are the most common channels, and the channel layout is the combination of them. <br>
For example, audio 5.1(6 channels) may be the most famous type, which has a standard in <a href="https://www.itu.int/rec/R-REC-BS.775/en" title="ITU-R BS.775">ITU-R BS.775</a>. <br>
It contains <em>left</em>, <em>right</em>, <em>center</em>, <em>low frequency effect</em>, <em>left surround</em> <br>
and <em>right surround</em> channels. <br>
However, it has a vague definition for <em>left/right surround</em> channels. <br>
It could be <em>back left/right</em> or <em>side left/right</em>.</p>

<p>It may be a historical issue. <br>
There is probably only one rear left and right speaker when 5.1 is proposed. <br>
The channel layout now is up to 22.2(24 channels), which is specified in <a href="http://www.itu.int/pub/R-REP-BS.2159" title="ITU-R BS.2159">ITU-R BS.2159</a>, so we need to distinguish the different speakers in the rear.</p>

<p><em>FFmpeg</em> and <em>chromium</em> are good references for the most frequently used layout:</p>

<ul>
<li><a href="https://www.ffmpeg.org/doxygen/2.7/group__channel__mask__c.html">FFmpeg audio channel layouts</a> (<a href="https://www.ffmpeg.org/doxygen/2.7/channel__layout_8h_source.html">channel_layout.h</a>)</li>
<li><a href="https://cs.chromium.org/chromium/src/media/base/channel_layout.h">channel layout in chromium</a></li>
</ul>

<p>To be clear, we list some common combination here:</p>

<table>
<thead>
<tr>
  <th>Num. of ch.</th>
  <th>Name</th>
  <th>Layout combination</th>
</tr>
</thead>
<tbody><tr>
  <td>1</td>
  <td>Mono</td>
  <td>FC</td>
</tr>
<tr>
  <td>2</td>
  <td>Stereo</td>
  <td>FL, FR</td>
</tr>
<tr>
  <td>3</td>
  <td>2-1</td>
  <td>FL, FR, BC</td>
</tr>
<tr>
  <td>3</td>
  <td>2.1</td>
  <td>FL, FR, LFE</td>
</tr>
<tr>
  <td>3</td>
  <td>3.0</td>
  <td>FL, FR, FC</td>
</tr>
<tr>
  <td>4</td>
  <td>3.1</td>
  <td>FL, FR, FC, LFE</td>
</tr>
<tr>
  <td>4</td>
  <td>4.0</td>
  <td>FL, FR, FC, BC</td>
</tr>
<tr>
  <td>4</td>
  <td>Quad</td>
  <td>FL, FR, BL, BR</td>
</tr>
<tr>
  <td>5</td>
  <td>4.1</td>
  <td>FL, FR, FC, LFE, BC</td>
</tr>
<tr>
  <td>5</td>
  <td>5.0(side)</td>
  <td>FL, FR, FC, SL, SR</td>
</tr>
<tr>
  <td>5</td>
  <td>5.0(back)</td>
  <td>FL, FR, FC, BL, BR</td>
</tr>
<tr>
  <td>6</td>
  <td>5.1(side)</td>
  <td>FL, FR, FC, LFE, SL, SR</td>
</tr>
<tr>
  <td>6</td>
  <td>5.1(back)</td>
  <td>FL, FR, FC, LFE, BL, BR</td>
</tr>
</tbody></table>


<h4 id="1-channel"><strong>.1</strong> channel</h4>

<p>Because <em>LFE</em> channel requires only a fraction of the bandwidth ot other audio channels, it refers to the <strong>.1</strong> channel(e.g., 5.1 and 7.1).</p>



<h3 id="channel-order">Channel Order</h3>

<p>SMPTE and ITU define a standard order for channels. <br>
The general channel assignment table from <a href="http://www.itu.int/pub/R-REP-BS.2159" title="ITU-R BS.2159">ITU-R BS.2159</a> is:</p>

<table>
<thead>
<tr>
  <th>Ch. num.</th>
  <th>label</th>
  <th>Full name</th>
</tr>
</thead>
<tbody><tr>
  <td>1</td>
  <td>FL</td>
  <td>Front Left</td>
</tr>
<tr>
  <td>2</td>
  <td>FR</td>
  <td>Front Right</td>
</tr>
<tr>
  <td>3</td>
  <td>FC</td>
  <td>Front Centre</td>
</tr>
<tr>
  <td>4</td>
  <td>LFE1</td>
  <td>Low Frequency Effects-1</td>
</tr>
<tr>
  <td>5</td>
  <td>BL</td>
  <td>Back Left</td>
</tr>
<tr>
  <td>6</td>
  <td>BR</td>
  <td>Back Right</td>
</tr>
<tr>
  <td>7</td>
  <td>FLc</td>
  <td>Front Left Centre</td>
</tr>
<tr>
  <td>8</td>
  <td>FRc</td>
  <td>Front Right Centre</td>
</tr>
<tr>
  <td>9</td>
  <td>BC</td>
  <td>Back Centre</td>
</tr>
<tr>
  <td>10</td>
  <td>LFE2</td>
  <td>Low Frequency Effects-2</td>
</tr>
<tr>
  <td>11</td>
  <td>Sil</td>
  <td>Side Left</td>
</tr>
<tr>
  <td>12</td>
  <td>SiR</td>
  <td>Side Right</td>
</tr>
<tr>
  <td>…</td>
  <td>…</td>
  <td>…</td>
</tr>
</tbody></table>


<p>However, they are various in the real world.  <br>
For example, <em>Microsoft</em> defines <a href="https://msdn.microsoft.com/en-us/library/windows/hardware/dn653308%28v=vs.85%29.aspx#Default_Channel_Ordering">their own order</a>.</p>

<p>To know more about channel order, take a look its definition in <a href="https://cs.chromium.org/chromium/src/media/base/channel_layout.cc">chromium project</a>.</p>

<h3 id="channel-manipulation">Channel Manipulation</h3>

<ul>
<li>Downmix: input channel number &gt; output channel number</li>
<li>Upmix: input channel number &lt; output channel number</li>
</ul>

<p>The <a href="https://trac.ffmpeg.org/wiki/AudioChannelManipulation">channel manipulations in FFmpeg</a>:</p>

<ul>
<li>stereo → mono stream</li>
<li>stereo → 2 × mono files</li>
<li>stereo → 2 × mono streams</li>
<li>mono → stereo</li>
<li>2 × mono → stereo</li>
<li>6 × mono → 5.1</li>
<li>5.1 → 6 × mono</li>
<li>5.1 → stereo</li>
<li>2 × stereo → stereo</li>
<li>Mix both stereo channels to stereo</li>
<li>Switch stereo channels</li>
<li>Mute a channel</li>
</ul></div></body>
</html>
