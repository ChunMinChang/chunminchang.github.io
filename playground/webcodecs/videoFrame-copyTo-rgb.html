<html>
  <head>
    <title>VideoFrame copyTo RGB</title>
    <style>
      .box {
        float: left;
        margin-right: 10px;
        height: 30px;
        width: 30px;
        border: 1px solid black;
        clear: both;
      }
    </style>
    <script>
      const WIDTH = 20;
      const HEIGHT = 20;
      var color;
      var alpha;

      function hexToRGB(hex) {
        // const r = parseInt(hex.substring(0, 2), 16);
        // const g = parseInt(hex.substring(2, 4), 16);
        // const b = parseInt(hex.substring(4, 6), 16);
        const bits = parseInt(hex, 16);
        const r = (bits >> 16) & 0xff;
        const g = (bits >> 8) & 0xff;
        const b = bits & 0xff;
        return [r, g, b];
      }

      function rgb2yuv(r, g, b) {
        let y = r * 0.299 + g * 0.587 + b * 0.114;
        let u = r * -0.168736 + g * -0.331264 + b * 0.5 + 128;
        let v = r * 0.5 + g * -0.418688 + b * -0.081312 + 128;

        y = Math.round(y);
        u = Math.round(u);
        v = Math.round(v);
        return [y, u, v];
      }

      function showColorInfo(color, alpha) {
        const info = document.getElementById("colorinfo");

        const [r, g, b] = hexToRGB(color.substring(1));
        const rgbyuv = info.querySelector("p[name='rgb-yuv']");
        rgbyuv.innerText =
          color + ": (R, G, B) = (" + r + ", " + g + ", " + b + ")";

        const [y, u, v] = rgb2yuv(r, g, b);
        rgbyuv.innerText +=
          " ---> (Y, U, V) = (" + y + ", " + u + ", " + v + "), A: " + alpha;

        const sample = info.querySelector("div[name='color-sample']");
        const alphaValue = alpha / 255;
        sample.style.backgroundColor =
          "rgba(" + [r, g, b, alphaValue].join(",") + ")";
      }

      function updateColor(event) {
        color = event.target.value;
        showColorInfo(color, alpha);
      }

      function updateAlpha(event) {
        alpha = event.target.value;
        showColorInfo(color, alpha);
      }

      function getTestResultElements(element) {
        const canvas = element.querySelector("canvas");
        const bytes = element.querySelector("textarea[name='bytes']");
        const copyTo = element.querySelector("textarea[name='copyTo']");
        return [canvas, bytes, copyTo];
      }

      function resetTestElements(element) {
        const [canvas, bytes, copyTo] = getTestResultElements(element);
        canvas.width = WIDTH;
        canvas.height = HEIGHT;
        bytes.value = "";
        if (copyTo) {
          copyTo.value = "";
        }
      }

      function fillStandardCanvas(element, color) {
        const [canvas, bytes, _] = getTestResultElements(element);
        const ctx = canvas.getContext("2d");
        // Fill whole canvas.
        ctx.fillStyle = color;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        // Show the RGB data retrieved from canvas.
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = new Uint8Array(imageData.data.buffer);
        bytes.value = data;
      }

      function drawVideoFrame(
        element,
        color,
        format,
        colorSpace,
        buffer,
        width,
        height
      ) {
        const init = {
          format: format,
          timestamp: 0,
          codedWidth: width,
          codedHeight: height,
          colorSpace: colorSpace,
        };
        const frame = new VideoFrame(buffer, init);

        const ctxColorSpace =
          document.getElementById("copyTo-colorspace").value;
        const [canvas, bytes, copyTo] = getTestResultElements(element);
        const ctx = canvas.getContext("2d", {
          colorSpace: ctxColorSpace,
          willReadFrequently: true,
        });

        // Get VideoFrame pixels via copyTo()
        const options = {
          rect: { x: 0, y: 0, width: width, height: height },
          format: document.getElementById("copyTo-format").value,
          colorSpace: ctxColorSpace,
        };
        const copytoImageData = ctx.createImageData(width, height);
        const copytoBuf = copytoImageData.data.buffer;

        frame
          .copyTo(copytoBuf, options)
          .then((layout) => {
            const copytoData = new Uint8Array(copytoBuf);
            copyTo.value = copytoData;
          })
          .catch((error) => {
            const logs = document.getElementById("errorlog");
            const para = document.createElement("p");
            const msg = document.createTextNode(error);
            para.appendChild(msg);
            logs.appendChild(para);
          });

        // Get the RGB data retrieved from canvas drawn by the given VideoFrame.
        ctx.drawImage(
          frame,
          0,
          0,
          frame.codedWidth,
          frame.codedHeight,
          0,
          0,
          frame.codedWidth,
          frame.codedHeight
        );

        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height, {
          colorSpace: ctxColorSpace,
        });
        const data = new Uint8Array(imageData.data.buffer);
        bytes.value = data;

        frame.close();
      }

      function drawRGBXFrame(element, color, format, colorSpace) {
        const hasAlpha = format.includes("A");

        const [r, g, b] = hexToRGB(color.substring(1));
        const size = WIDTH * HEIGHT * 4;
        const buffer = new Uint8Array(size);
        for (let i = 0; i < size; i += 4) {
          buffer.fill(r, i, i + 1);
          buffer.fill(g, i + 1, i + 2);
          buffer.fill(b, i + 2, i + 3);
          if (hasAlpha) {
            buffer.fill(alpha, i + 3, i + 4);
          }
        }

        drawVideoFrame(
          element,
          color,
          format,
          colorSpace,
          buffer,
          WIDTH,
          HEIGHT
        );
      }

      function drawI420Frame(element, color, format, colorSpace) {
        const [r, g, b] = hexToRGB(color.substring(1));
        const [y, u, v] = rgb2yuv(r, g, b);

        const hasAlpha = format.includes("A");

        const ySize = WIDTH * HEIGHT;
        const uSize = ((WIDTH / 2) * HEIGHT) / 2;
        const vSize = ((WIDTH / 2) * HEIGHT) / 2;
        const aSize = ySize;

        const buffer = new Uint8Array(
          ySize + uSize + vSize + (hasAlpha ? aSize : 0)
        );
        buffer.fill(y, 0, ySize);
        buffer.fill(u, ySize, ySize + uSize);
        buffer.fill(v, ySize + uSize, ySize + uSize + vSize);
        if (hasAlpha) {
          buffer.fill(
            alpha,
            ySize + uSize + vSize,
            ySize + uSize + vSize + aSize
          );
        }

        drawVideoFrame(
          element,
          color,
          format,
          colorSpace,
          buffer,
          WIDTH,
          HEIGHT
        );
      }

      function drawVideoFrames(color) {
        const colorspace = {
          bt709: {
            matrix: "bt709",
            primaries: "bt709",
            transfer: "bt709",
            fullRange: false,
          },
          smpte170m: {
            matrix: "smpte170m",
            primaries: "smpte170m",
            transfer: "smpte170m",
            fullRange: false,
          },
        };
        const set = [
          {
            id: "videoframe-RGBX-BT709",
            format: "RGBX",
            colorspace: colorspace.bt709,
          },
          {
            id: "videoframe-RGBX-SMPTE170M",
            format: "RGBX",
            colorspace: colorspace.smpte170m,
          },
          {
            id: "videoframe-RGBA-BT709",
            format: "RGBA",
            colorspace: colorspace.bt709,
          },
          {
            id: "videoframe-RGBA-SMPTE170M",
            format: "RGBA",
            colorspace: colorspace.smpte170m,
          },
          {
            id: "videoframe-I420-BT709",
            format: "I420",
            colorspace: colorspace.bt709,
          },
          {
            id: "videoframe-I420-SMPTE170M",
            format: "I420",
            colorspace: colorspace.smpte170m,
          },
          {
            id: "videoframe-I420A-BT709",
            format: "I420A",
            colorspace: colorspace.bt709,
          },
          {
            id: "videoframe-I420A-SMPTE170M",
            format: "I420A",
            colorspace: colorspace.smpte170m,
          },
        ];
        for (const s of set) {
          const element = document.getElementById(s.id);
          if (s.format.includes("I420")) {
            drawI420Frame(element, color, s.format, s.colorspace);
          } else if (s.format.includes("RGB")) {
            drawRGBXFrame(element, color, s.format, s.colorspace);
          }
        }
      }

      function runTest(event) {
        fillStandardCanvas(document.getElementById("standard"), color);
        drawVideoFrames(color);
      }

      document.addEventListener("DOMContentLoaded", (event) => {
        // Initialize color picker.
        color = "#ff0000";
        const colorPicker = document.getElementById("colorPicker");
        colorPicker.addEventListener("input", updateColor, false);
        colorPicker.addEventListener("change", updateColor, false);
        colorPicker.value = color;

        // Initialize alpha picker.
        alpha = "128";
        const alphaPicker = document.getElementById("alphaPicker");
        alphaPicker.addEventListener("input", updateAlpha, false);
        alphaPicker.addEventListener("change", updateAlpha, false);
        alphaPicker.value = alpha;

        showColorInfo(color, alpha);

        // Initialize button.
        const button = document.getElementById("draw");
        button.addEventListener("click", runTest);

        // Initialize canvas and debug info.
        const canvasDivs = document.body.getElementsByClassName("canvas");
        for (const c of canvasDivs) {
          resetTestElements(document.getElementById(c.id));
        }
      });
    </script>

    <body>
      <h1>VideoFrame copyTo RGB</h1>
      <p>Pick color and format, then click Draw</p>
      <label>Color Picker</label>
      <input type="color" id="colorPicker" />
      <label>alpha</label>
      <input type="range" id="alphaPicker" min="0" max="255" />
      <br />
      <label>copyTo format</label>
      <select id="copyTo-format">
        <option value="RGBA">RGBA</option>
        <option value="RGBX">RGBX</option>
        <option value="BGRA">BGRA</option>
        <option value="BGRX">BGRX</option>
      </select>
      <label>copyTo colorspace</label>
      <select id="copyTo-colorspace">
        <option value="srgb">srgb</option>
        <option value="display-p3">display-p3</option>
      </select>
      <button id="draw">Draw</button>
      <div id="colorinfo">
        <div name="color-sample" class="box"></div>
        <p name="rgb-yuv"></p>
        <p>Y = 0.299 * R + 0.587 * G + 0.114 * B</p>
        <p>U = -0.169 * R - 0.331 * G + 0.5 * B + 128</p>
        <p>V = 0.5 * R - 0.419 * G - 0.081 * B + 128</p>
      </div>
      <p>The canvas size is 20 x 20</p>
      <div id="errorlog"></div>

      <div class="canvas" id="standard">
        <h2>fillRect</h2>
        <canvas></canvas>
        bytes: <textarea name="bytes" readonly></textarea>
      </div>

      <div class="canvas" id="videoframe-RGBX-BT709">
        <h2>drawImage with VideoFrame RGBX BT709</h2>
        <canvas></canvas>
        bytes: <textarea name="bytes" readonly></textarea> copyTo:
        <textarea name="copyTo" readonly></textarea>
      </div>

      <div class="canvas" id="videoframe-RGBX-SMPTE170M">
        <h2>drawImage with VideoFrame RGBX SMPTE170M</h2>
        <canvas></canvas>
        bytes: <textarea name="bytes" readonly></textarea> copyTo:
        <textarea name="copyTo" readonly></textarea>
      </div>

      <div class="canvas" id="videoframe-RGBA-BT709">
        <h2>drawImage with VideoFrame RGBA BT709</h2>
        <canvas></canvas>
        bytes: <textarea name="bytes" readonly></textarea> copyTo:
        <textarea name="copyTo" readonly></textarea>
      </div>

      <div class="canvas" id="videoframe-RGBA-SMPTE170M">
        <h2>drawImage with VideoFrame RGBA SMPTE170M</h2>
        <canvas></canvas>
        bytes: <textarea name="bytes" readonly></textarea> copyTo:
        <textarea name="copyTo" readonly></textarea>
      </div>

      <div class="canvas" id="videoframe-I420-BT709">
        <h2>drawImage with VideoFrame I420 BT709</h2>
        <canvas></canvas>
        bytes: <textarea name="bytes" readonly></textarea> copyTo:
        <textarea name="copyTo" readonly></textarea>
      </div>

      <div class="canvas" id="videoframe-I420-SMPTE170M">
        <h2>drawImage with VideoFrame I420 SMPTE170M</h2>
        <canvas></canvas>
        bytes: <textarea name="bytes" readonly></textarea> copyTo:
        <textarea name="copyTo" readonly></textarea>
      </div>

      <div class="canvas" id="videoframe-I420A-BT709">
        <h2>drawImage with VideoFrame I420A BT709</h2>
        <canvas></canvas>
        bytes: <textarea name="bytes" readonly></textarea> copyTo:
        <textarea name="copyTo" readonly></textarea>
      </div>

      <div class="canvas" id="videoframe-I420A-SMPTE170M">
        <h2>drawImage with VideoFrame I420A SMPTE170M</h2>
        <canvas></canvas>
        bytes: <textarea name="bytes" readonly></textarea> copyTo:
        <textarea name="copyTo" readonly></textarea>
      </div>
    </body>
  </head>
</html>
