<html>
<head>
<title>Zero Sink Counter</title>
<!-- Google Chart:
  See more detail in https://developers.google.com/chart/interactive/docs/gallery/linechart -->
<script type='text/javascript' src='https://www.gstatic.com/charts/loader.js'></script>
<script type='text/javascript' src='random.js'></script>
<script type='text/javascript' src='zero_sink_counter.js'></script>
<script type='text/javascript'>
//
//  non-zero         /-----\              /-----\             /-----\
//  (+ or /)        /       \            /       \           /       \
//                 /         \          /         \         /         \
//  zero  --------/           \--------/           \-------/           \-------
//                                ^                    ^
//                              sink!                sink!
// The test is used to check we can calculate how many sinks in a given data.
// The size of a sink must be larger than `N`, or it's not a sink.
//
// ============================================================================
//   Test
// ============================================================================
function PushData(array, length, value) {
  while (length) {
    array.push(value);
    --length;
  }
}

// // Generate fixed data pattern.
// function GenerateSinks(num, size) {
//   let data = [];

//   // Append zero values whose size is longer than sink's size.
//   PushData(data, size + 1, 0);

//   for (let i = 0 ; i < num ; ++i) {
//     // Append some non-zero values in front of the current 0s
//     // and in rear of the previous 0s.
//     PushData(data, size + 1, 1);
//     // Append zeros to produce a zero sink.
//     PushData(data, size, 0);
//   }

//   // Append some non-zero values, in the end of the last 0s,
//   // to produce a zero sink.
//   PushData(data, size + 1, 1);

//   // Append zero values whose size is longer than sink's size,
//   // in the end of the data.
//   PushData(data, size + 1, 0);

//   return data;
// }

// Generate non-zero values with sum = 0 and push them into the array.
function PushNonZeroButZeroSumData(array, length) {
  console.assert(length > 1, '[PushNonZeroButZeroSumData] length must be larger than 2!');
  // if (!length) {
  //   return;
  // } else if (length == 1) {
  //   array.push(0);
  //   return;
  // }
  let half = length / 2;
  let l = 1;
  while (l <= half) {
    array.push(l);
    array.push(0-l)
    ++l;
  }
  if (2*l - length == 1) { // when length is odd.
    array[array.length - 1] -= l;
    array.push(l);
  }
}

function PushNonZeroData(array, length, zeroSum)
{
  console.assert(length > 0, '[PushNonZeroData] length must be larger than zero!');
  if (zeroSum) {
    // set min to 2 in case we append 0 into the data.
    if (length < 2) {
      length = 2;
    }
    PushNonZeroButZeroSumData(array, length);
  } else {
    PushData(array, length, 1);
  }
}

function GenerateSinks(num, size, rand) {
  let data = [];
  let len = 0;

  // Append zero values whose size is longer than sink's size.
  if (!rand || GetRandomBool()) {
    len = rand ? GetRandomInt(size, size + 5) : size + 1;
    PushData(data, len, 0);
  }

  for (let i = 0 ; i < num ; ++i) {
    // Append some non-zero values in front of the current 0s
    // and in rear of the previous 0s.
    len = rand ? GetRandomInt(1, size + 5) : 1;
    PushNonZeroData(data, len, rand && GetRandomBool());

    // Append zeros to produce a zero sink.
    len = rand ? GetRandomInt(size, size + len) : size;
    PushData(data, len, 0);
  }

  // Append some non-zero values, in the end of the last 0s,
  // to produce a zero sink.
  len = rand ? GetRandomInt(1, size + 5) : size + 1;
  PushNonZeroData(data, len, rand && GetRandomBool());

  // Append zero values whose size is longer than sink's size,
  // in the end of the data.
  if (!rand || GetRandomBool()) {
    len = rand ? GetRandomInt(size, size + 5) : size + 1;
    PushData(data, len, 0);
  }

  return data;
}

function CountZeroSinks(data, size)
{
  let zsc = new ZeroSinkCounter(size);
  for (let i = 0 ; i < data.length ; ++i) {
    zsc.count(data[i]);
  }
  return zsc.sinks;
}

function DumpData(data) {
  for (let i = 0 ; i < data.length ; ++i) {
    console.log(data[i]);
  }
}

// Google Chart:
//   https://developers.google.com/chart/interactive/docs/gallery/linechart
function DrawDataWave(data) {
  google.charts.load('current', {'packages':['corechart']});
  google.charts.setOnLoadCallback(drawChart);

  function convertToTable(data) {
    let table = [];
    table.push(['time', 'data']);
    for (let i = 0 ; i < data.length ; ++i) {
      table.push([i, data[i]]);
    }
    return table;
  }

  function drawChart() {
    let chartData = google.visualization.arrayToDataTable(convertToTable(data));
    let options = {
      title: 'Data',
      // curveType: 'function',
      // legend: { position: 'bottom' }
    };
    let chart = new google.visualization.LineChart(document.getElementById('curve_chart'));
    chart.draw(chartData, options);
  }
}

function ShowAnswer(sinks, size, count) {
  document.getElementById('sink').innerHTML = sinks;
  document.getElementById('length').innerHTML = size;
  document.getElementById('expect').innerHTML = sinks;
  document.getElementById('get').innerHTML = count;
}

function Test(rand) {
  const sinks = rand ? GetRandomInt(3, 10) : 3;
  const size = rand ? GetRandomInt(3, 10) : 4;
  let data = GenerateSinks(sinks, size, rand);
  DumpData(data);
  let count = CountZeroSinks(data, size);
  console.log('Expect: ' + sinks + ', Get: ' + count);
  console.assert(count == sinks, 'Expect:' + sinks + ' but get: ' + count);
  DrawDataWave(data);
  ShowAnswer(sinks, size, count);
}

document.addEventListener('DOMContentLoaded', function(event) {
  // Generate a fixed pattern test.
  Test(false);
  // Setup the button for generating random test.
  let btn = document.getElementById('run');
  btn.addEventListener('click', function(e) {
    Test(true);
  }, false);
}, false);
</script>
</head>
<body>
  <div id='content'>
    <h1>Zero Sink Counter</h1>
    <!-- Google Chart: See more detail in https://developers.google.com/chart/interactive/docs/gallery/linechart -->
    <div id='curve_chart' style='width: 900px; height: 500px'></div>
    <div id='test'>
      <button id='run' style='background-color: #4CAF50; color: white; font-size: 16px;'>run test</button>
      <br>
      Data contains <text id='sink'></text> sinks with length <text id='length'></text>
      <br>
      Expect: <text id='expect'></text>,
      Get: <text id='get'></text>
      <br>
    </div>
    <div id='intro'>
      <h2>Introduction</h2>
      <b>Goal</b>
      <p>blah blah blah blah ...</p>
      <b>Motivation</b>
      <p>blah blah blah blah ...</p>
      <h2>Algorithm</h2>
      See the implementation detail in <a href='zero_sink_counter.js' target='_blank'>zero_sink_counter.js</a>
    </div>
  </div>
</body>
</html>