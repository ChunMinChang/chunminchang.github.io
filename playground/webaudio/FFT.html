<html>
<head>
<title>FFT Plot</title>
<script>
// Reference: https://searchfox.org/mozilla-central/rev/03877052c151a8f062eea177f684a2743cd7b1d5/dom/media/tests/mochitest/head.js#183
/**
 * This class provides utilities to operate an OscillatorNode.
 *
 * @constructor
 * @param {AudioContext} audioContext
 *        AudioContext in which to create the OscillatorNode.
 * @param {double} frequency
 *        The frequency of the Oscillator.
 */
function Oscillator(audioContext, frequency)
{
  this.context = audioContext;
  this.oscillator = this.context.createOscillator();
  this.oscillator.frequency.value = frequency;
  // this.destination = this.context.createMediaStreamDestination();
  // this.oscillator.connect(this.destination);
}

Oscillator.prototype = {
  /**
   * Get the internal OscillatorNode.
   */
  get node() {
    return this.oscillator;
  },
  /**
   * Get the audio stream of the internal OscillatorNode.
   */
  // get stream() {
  //   return this.destination.stream;
  // },
  /**
   * Start the OscillatorNode.
   */
  start: function() {
    this.oscillator.start();
  },
  /**
   * Stop the OscillatorNode.
   *   Once it stops, it cannot start again.
   */
  stop: function() {
    this.oscillator.stop();
  }
};

// Reference: https://searchfox.org/mozilla-central/rev/f42618c99dcb522fb674221acfbc68c2d92e7936/dom/media/tests/mochitest/head.js#33
/**
 * This class provides helpers around analysing the audio content in a stream
 * using WebAudio AnalyserNodes.
 *
 * @constructor
 * @param {AudioContext} audioContext
 *        AudioContext in which to create the AnalyserNode.
 */
function AudioAnalyser(audioContext) {
  this.context = audioContext;
  this.analyser = this.context.createAnalyser();
  // this.analyser.smoothingTimeConstant = 0.2;
  this.analyser.fftSize = 1024;
  this.fftData = new Uint8Array(this.analyser.frequencyBinCount);
}

AudioAnalyser.prototype = {
  /**
   * Get the internal AnalyserNode for analysing the audio stream.
   */
  get node() {
    return this.analyser;
  },

  /**
   * Get an array of frequency domain data for our stream's audio track.
   *
   * @returns {array} A Uint8Array containing the frequency domain data.
   */
   get frequencyData() {
     this.analyser.getByteFrequencyData(this.fftData);
     return this.fftData;
   },

  /**
   * Return the FFT bin index for a given frequency.
   *
   * @param {double} frequency
   *        The frequency for whicht to return the bin number.
   * @returns {integer} the index of the bin in the FFT array.
   */
  binIndexForFrequency: function(frequency) {
    return 1 + Math.round(frequency * this.analyser.fftSize / this.context.sampleRate);
  },

  /**
   * Reverse operation, get the frequency for a bin index.
   *
   * @param {integer} index an index in an FFT array
   * @returns {double} the frequency for this bin
   */
  frequencyForBinIndex: function(index) {
    return (index - 1) * this.context.sampleRate / this.analyser.fftSize;
  },

  /**
   * Append a canvas to the DOM where the frequency data are drawn.
   */
   openSpectrum: function(content) {
    let cvs = this.fftCanvas = document.createElement("canvas");
    content.insertBefore(cvs, content.children[0]);

    // Easy: 1px per bin
    cvs.width = this.analyser.frequencyBinCount;
    cvs.height = 200;
    cvs.style.border = "1px solid red";

    let c = cvs.getContext('2d');
    c.fillStyle = 'black';

    let self = this;
    function render() {
      c.clearRect(0, 0, cvs.width, cvs.height);
      let array = self.frequencyData;
      for (let i = 0; i < array.length; ++i) {
        // if (array[i]) {
        //   console.log(i + " (" + self.frequencyForBinIndex(i) + "hz): " + array[i]);
        // }
        c.fillRect(i, (cvs.height - (array[i] / 2)), 1, cvs.height);
      }
      if (!cvs.stopDrawing) {
        requestAnimationFrame(render);
      }
    }
    requestAnimationFrame(render);
  },

  /**
   * Stop drawing of and remove the canvas from the DOM.
   */
   closeSpectrum: function() {
    if (!this.fftCanvas || !this.fftCanvas.parentElement) {
      return;
    }

    this.fftCanvas.stopDrawing = true;
    this.fftCanvas.parentElement.removeChild(this.fftCanvas);
  },

  /**
   * Append a canvas to the DOM where the variation of frequency data are drawn.
   */
   openVariation: function(content) {
    let cvs = this.variationCanvas = document.createElement("canvas");
    content.appendChild(cvs);

    // Easy: 1px per bin
    cvs.width = this.analyser.frequencyBinCount;
    cvs.height = 200;
    cvs.style.border = "1px solid red";

    let c = cvs.getContext('2d');
    c.fillStyle = 'black';

    let lastArray = [];
    let self = this;
    function render() {
      c.clearRect(0, 0, cvs.width, cvs.height);
      let array = self.frequencyData;
      if (lastArray.length) {
        for (let i = 0; i < array.length; ++i) {
          let diff = Math.abs(lastArray[i] - array[i]);
          c.fillRect(i, cvs.height - 100 * diff, 1, cvs.height);
          // if (diff) {
          //   console.log(i + " - last: " + lastArray[i] + ", current: " + array[i]);
          // }
        }
      }
      if (!cvs.stopDrawing) {
        requestAnimationFrame(render);
      }
      lastArray = array.slice(0);
    }
    requestAnimationFrame(render);
  },

  /**
   * Stop drawing of and remove the canvas from the DOM.
   */
   closeVariation: function() {
    if (!this.variationCanvas || !this.variationCanvas.parentElement) {
      return;
    }

    this.variationCanvas.stopDrawing = true;
    this.variationCanvas.parentElement.removeChild(this.variationCanvas);
  },

  /**
   * Append a canvas to the DOM where the noise of frequency data are drawn.
   */
   openNoise: function(content) {
    let cvs = this.noiseCanvas = document.createElement("canvas");
    content.appendChild(cvs);

    // Easy: 1px per bin
    cvs.width = this.analyser.frequencyBinCount;
    cvs.height = 200;
    cvs.style.border = "1px solid red";

    let c = cvs.getContext('2d');
    c.fillStyle = 'black';

    let lastArray = [];
    let self = this;
    function render() {
      c.clearRect(0, 0, cvs.width, cvs.height);
      let array = self.frequencyData;
      if (lastArray.length) {
        for (let i = 0; i < array.length; ++i) {
          let noise = ((array[i] == 0 && lastArray[i] != 0) ||
                       (array[i] != 0 && lastArray[i] == 0)) ? 1 : 0;
          c.fillRect(i, cvs.height - 100 * noise, 1, cvs.height);
          // if (noise) {
          //   console.log(i + " - last: " + lastArray[i] + ", current: " + array[i]);
          // }
        }
      }
      if (!cvs.stopDrawing) {
        requestAnimationFrame(render);
      }
      lastArray = array.slice(0);
    }
    requestAnimationFrame(render);
  },

  /**
   * Stop drawing of and remove the canvas from the DOM.
   */
   closeNoise: function() {
    if (!this.noiseCanvas || !this.noiseCanvas.parentElement) {
      return;
    }

    this.noiseCanvas.stopDrawing = true;
    this.noiseCanvas.parentElement.removeChild(this.noiseCanvas);
  },
};

// Create an audio context.
var context = new AudioContext();
// Create an AudioAnalyser and connect its AnalyserNode to the destination
// of the audio context.
var analyser = new AudioAnalyser(context);
analyser.node.connect(context.destination);
// An Oscillator that will be connected to the analyser.
var oscillator;

function start()
{
  analyser.openSpectrum(document.getElementById("plot"));
  analyser.openVariation(document.getElementById("diff"));
  analyser.openNoise(document.getElementById("noise"));
  let frequency = document.getElementById("frequency").value;
  oscillator = new Oscillator(context, frequency);
  oscillator.node.connect(analyser.node);
  oscillator.start();
}

function stop()
{
  oscillator.stop();
  analyser.closeSpectrum();
  analyser.closeVariation();
  analyser.closeNoise();
}

function toggleSwitch(evt)
{
  let btn = document.getElementById("switch");
  if (btn.innerHTML == "" || btn.innerHTML == "stop") {
    btn.innerHTML = "play";
    stop();
  } else {
    btn.innerHTML = "stop";
    start();
  }
}

document.addEventListener("DOMContentLoaded", function(evt) {
  console.log("DOM Content has been loaded.");
  let btn = document.getElementById("switch");
  btn.addEventListener("click", toggleSwitch, false);
}, false);

</script>
</head>
<body>
  <H1>WebAudio FFT Tester</H1>
  <p>Play a sine wave and show its frequency-domain data</p>
  <input id="frequency" type="number" value="440">Hz
  <button id="switch">play</button>
  <h2>Fast Fourier transform(FFT)</h2>
  <div id="plot"></div>
  <h2>Variation of FFT data</h2>
  <p>Comparing current data with last one at the same frequency.</p>
  <p>The data below is 100x of the variation.</p>
  <div id="diff"></div>
  <h2>Noise</h2>
  <p>Show when the frequency data changes from 0 to non-0, or from non-0 to 0.</p>
  <div id="noise"></div>
</body>
</html>