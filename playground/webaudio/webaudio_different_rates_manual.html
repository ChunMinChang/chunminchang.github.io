<html>
  <head>
    <title>WebAudio Different Sample Rates Test</title>
  </head>
  <script>
    function createSineWaveInput(rate, frequency = 440) {
      const ctx = new AudioContext({ sampleRate: rate });
      const osc = ctx.createOscillator();
      osc.type = "sine";
      osc.frequency.value = frequency;
      const dest = new MediaStreamAudioDestinationNode(ctx);
      osc.connect(dest);
      osc.connections = [dest];
      return { ctx, osc, dest };
    }

    async function createMicrophoneInput(rate) {
      // Check if sampleRate constraint is supported
      const supportedConstraints =
        navigator.mediaDevices.getSupportedConstraints();
      const audioConstraints = supportedConstraints.sampleRate
        ? { sampleRate: { ideal: rate } }
        : true;

      const stream = await navigator.mediaDevices.getUserMedia({
        audio: audioConstraints,
      });

      // Log the actual sample rate we got
      const audioTrack = stream.getAudioTracks()[0];
      const settings = audioTrack.getSettings();
      console.log(
        `Requested sample rate: ${rate}, Got: ${
          settings.sampleRate || "unknown"
        }`
      );

      return { stream };
    }

    function createAudioSource(rate, stream, cloneTracks) {
      const ctx = new AudioContext({ sampleRate: rate });
      const sourceStream = new MediaStream(
        cloneTracks
          ? stream.getTracks().map((track) => track.clone())
          : stream.getTracks()
      );
      const sourceNode = ctx.createMediaStreamSource(sourceStream);
      sourceNode.connect(ctx.destination);
      return sourceNode;
    }

    async function waitForMessage(detectorNode, timeoutMs = 5000) {
      return new Promise((resolve, reject) => {
        // If the node's context is closed, resolve immediately.
        if (detectorNode.context.state === "closed") {
          return reject(
            new Error(
              `Detector at rate ${detectorNode.context.sampleRate} is closed.`
            )
          );
        }

        console.assert(
          !detectorNode.port.onmessage,
          "Expected no existing onmessage handler on the detector node."
        );

        const timeoutId = setTimeout(() => {
          reject(
            new Error(
              `Timed out waiting for message from detector at rate ${detectorNode.context.sampleRate}.`
            )
          );
        }, timeoutMs);

        detectorNode.port.onmessage = (event) => {
          clearTimeout(timeoutId);
          // Clear the handler after receiving a message.
          detectorNode.port.onmessage = null;
          resolve(event.data);
        };
      });
    }

    function assert(condition, message) {
      if (!condition) {
        console.error(message || "Assertion failed");
      }
    }

    function parseInputNumber(id, defaultValue) {
      const input = document.getElementById(id);
      const value = parseInt(input.value, 10);
      return isNaN(value) ? defaultValue : value;
    }

    function toggleOscillatorSettings(show) {
      document.getElementById("oscillator-settings").style.display = show
        ? ""
        : "none";
      document.getElementById("source-context-controls").style.display = show
        ? ""
        : "none";
    }

    function toggleSourceContextControls(show) {
      document.getElementById("source-context-controls").style.display = show
        ? ""
        : "none";
    }

    const TEST_STATE = { Running: true, Stopped: false };
    function setUpControls(div, state) {
      for (const child of div.children) {
        if (child.tagName == "BUTTON") {
          if (child.id === "run") {
            child.disabled = state === TEST_STATE.Running;
          } else {
            child.disabled = state === TEST_STATE.Stopped;
          }
        } else if (child.tagName == "DIV") {
          setUpControls(child, state);
        }
      }
    }

    async function run() {
      const sourceType = document.getElementById("sourceType").value;
      const sourceRate = parseInputNumber("sourceRate", 44100);
      const targetRate = parseInputNumber("targetRate", 32000);
      const toneFrequency = parseInputNumber("toneFrequency", 440);
      console.log(
        `Source Type: ${sourceType}, Source Rate: ${sourceRate}, Target Rate: ${targetRate}, Tone Frequency: ${toneFrequency}`
      );
      const cloneTracks = document.getElementById("cloneTracks").checked;

      let inputStream;
      let input; // This will hold the context and nodes for the source
      if (sourceType === "microphone") {
        input = await createMicrophoneInput(sourceRate);
        inputStream = input.stream;
      } else {
        input = createSineWaveInput(sourceRate, toneFrequency);
        inputStream = input.dest.stream;
        input.osc.start();
      }

      toggleOscillatorSettings(sourceType === "oscillator");

      const output = createAudioSource(targetRate, inputStream, cloneTracks);

      // Setup actions for control buttons

      const toggleSourceButton = document.getElementById("toggleSource");
      toggleSourceButton.onclick = () => {
        inputStream.getTracks().forEach((track) => {
          track.enabled = !track.enabled;
        });
        toggleSourceButton.textContent =
          (inputStream.getTracks().some((track) => track.enabled)
            ? "disable"
            : "enable") + " source stream";
      };

      const stopSourceButton = document.getElementById("stopSource");
      stopSourceButton.onclick = () => {
        inputStream.getTracks().forEach((track) => {
          track.stop();
        });
        stopSourceButton.disabled = true;
        toggleSourceButton.disabled = true;
      };

      const toggleOscillatorConnectionButton = document.getElementById(
        "toggleOscillatorConnection"
      );
      toggleOscillatorConnectionButton.onclick = () => {
        if (input.osc.connections.length > 0) {
          input.osc.disconnect();
          input.osc.connections = [];
          toggleOscillatorConnectionButton.textContent =
            "connect oscillator stream";
        } else {
          input.osc.connect(input.dest);
          input.osc.connections.push(input.dest);
          toggleOscillatorConnectionButton.textContent =
            "disconnect oscillator stream";
        }
        console.log("Oscillator numberOfOutputs:", input.osc.numberOfOutputs);
      };

      const stopOscillatorButton = document.getElementById("stopOscillator");
      stopOscillatorButton.onclick = () => {
        input.osc.stop();
        stopOscillatorButton.disabled = true;
        toggleOscillatorConnectionButton.disabled = true;
      };

      const toggleSourceContextButton = document.getElementById(
        "toggleSourceContext"
      );
      toggleSourceContextButton.onclick = async () => {
        if (input.ctx.state === "running") {
          await input.ctx.suspend();
          toggleSourceContextButton.textContent = "resume source context";
        } else {
          await input.ctx.resume();
          toggleSourceContextButton.textContent = "suspend source context";
        }
      };

      const closeSourceContextButton =
        document.getElementById("closeSourceContext");
      closeSourceContextButton.onclick = async () => {
        await input.ctx.close();
        closeSourceContextButton.disabled = true;
        toggleSourceContextButton.disabled = true;
      };

      const toggleTargetContextButton = document.getElementById(
        "toggleTargetContext"
      );
      toggleTargetContextButton.onclick = async () => {
        if (output.context.state === "running") {
          await output.context.suspend();
          toggleTargetContextButton.textContent = "resume target context";
        } else {
          await output.context.resume();
          toggleTargetContextButton.textContent = "suspend target context";
        }
      };

      const closeTargetContextButton =
        document.getElementById("closeTargetContext");
      closeTargetContextButton.onclick = async () => {
        await output.context.close();
        closeTargetContextButton.disabled = true;
        toggleTargetContextButton.disabled = true;
      };
    }

    window.addEventListener("DOMContentLoaded", (event) => {
      const controls = document.getElementById("controls");
      setUpControls(controls, TEST_STATE.Stopped);

      // Check sourceType at startup
      const sourceType = document.getElementById("sourceType");
      toggleOscillatorSettings(sourceType.value === "oscillator");

      const runButton = document.getElementById("run");
      runButton.addEventListener("click", () => {
        setUpControls(controls, TEST_STATE.Running);
        run();
      });

      sourceType.addEventListener("change", () => {
        toggleOscillatorSettings(sourceType.value === "oscillator");
      });
    });
  </script>
  <body>
    <p>
      Testing MediaStreamAudioSourceNode with different sample rates. Source can
      be either an oscillator (via MediaStreamAudioDestinationNode) or
      microphone (via getUserMedia).
    </p>
    <label for="sourceType">Input Source:</label>
    <select id="sourceType">
      <option value="oscillator" selected>Oscillator</option>
      <option value="microphone">Microphone</option>
    </select>
    <br />
    <input type="number" id="sourceRate" value="44100" />
    <label for="sourceRate">Source Rate (Hz)</label>
    <br />
    <input type="number" id="targetRate" value="32000" />
    <label for="targetRate">Target Rate (Hz)</label>
    <br />
    <div id="oscillator-settings">
      <input type="number" id="toneFrequency" value="440" />
      <label for="toneFrequency">Tone Frequency (Hz)</label>
      <br />
    </div>
    <input type="checkbox" id="cloneTracks" />
    <label for="cloneTracks"
      >Clone MediaStreamTracks when creating source</label
    >
    <br />
    <div id="controls">
      <button id="run">Start</button>
      <br />
      <button id="toggleSource" disabled>disable source stream</button>
      <br />
      <button id="stopSource" disabled>stop source stream</button>
      <br />
      <button id="toggleTargetContext" disabled>suspend target context</button>
      <br />
      <button id="closeTargetContext" disabled>close target context</button>
      <div id="source-context-controls">
        <button id="toggleOscillatorConnection" disabled>
          disconnect oscillator stream
        </button>
        <br />
        <button id="stopOscillator" disabled>stop oscillator stream</button>
        <br />
        <button id="toggleSourceContext" disabled>
          suspend source context
        </button>
        <br />
        <button id="closeSourceContext" disabled>close source context</button>
        <br />
      </div>
    </div>
  </body>
</html>
