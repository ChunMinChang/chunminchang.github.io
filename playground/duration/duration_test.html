<html>
<head>
  <meta charset="UTF-8">
  <title>Duration Test</title>
  <script>
    // Notes:
    // 1. Live stream audio links: https://www.klcc.org/live-stream-options
    // 2. Sine wave files are generated by "$ ffmpeg -f lavfi -i "sine=frequency=1000:duration=5" test.wav"
    // 3. The mp3 files converted from wav files are by https://github.com/ChunMinChang/raw2mp3
    var MATRICES = {
      MP3: [
        // Live Stream
        { name: "live stream mp3", source: "https://tektite.streamguys1.com:5025/klcc.mp3", duration: -1, },
        // Bug 1500713
        { name: "Bug 1500713: vbr mp3", source: "https://bug1500713.bmoattachments.org/attachment.cgi?id=9018840", duration: 171.89, },
        { name: "Bug 1500713: another vbr mp3", source: "https://bug1500713.bmoattachments.org/attachment.cgi?id=9018844", duration: 185.54, },
        // hyperion-records
        { name: "Hyperion: 18 MacCunn The Lay of the Last Minstrel - Part 2", source: "http://www.hyperion-records.co.uk/audiotest/18%20MacCunn%20The%20Lay%20of%20the%20Last%20Minstrel%20-%20Part%202%20Final%20chorus%20O%20Caledonia!%20stern%20and%20wild.MP3", duration: 174.84, },
        { name: "Hyperion: 3 Schubert String Quartet No 14 in D minor, D810 - 3 Scherzo Allegro molto", source: "http://www.hyperion-records.co.uk/audiotest/3%20Schubert%20String%20Quartet%20No%2014%20in%20D%20minor%20Death%20and%20the%20Maiden,%20D810%20-%20Movement%203%20Scherzo%20Allegro%20molto.MP3", duration: 220.13, },
        { name: "Hyperion: 14 Clementi Piano Sonata in D major, Op 25 No 6 - 2 Un poco andante", source: "http://www.hyperion-records.co.uk/audiotest/14%20Clementi%20Piano%20Sonata%20in%20D%20major,%20Op%2025%20No%206%20-%20Movement%202%20Un%20poco%20andante.MP3", duration: 166.64, },
        { name: "Hyperion: 1 Vaet Videns Dominus", source: "http://www.hyperion-records.co.uk/audiotest/1%20Vaet%20Videns%20Dominus.MP3", duration: 295.99, },
        { name: "Hyperion: 1 Sullivan The Lost Chord", source: "http://www.hyperion-records.co.uk/audiotest/1%20Sullivan%20The%20Lost%20Chord,%20Seated%20one%20day%20at%20the%20organ.MP3", duration: 244.27, },
        // 0.01s sine wave
        { name: "sine(441hz) 0.01s CBR(no header)", source: "ffmpeg_sine_441hz_0.01s_cbr_fraunhofer.mp3", duration: 0.01, },
        { name: "sine(441hz) 0.01s CBR(XING: Info)", source: "ffmpeg_sine_441hz_0.01s_cbr_xing_libmp3lame.mp3", duration: 0.01, },
        { name: "sine(441hz) 0.01s VBR(no header)", source: "ffmpeg_sine_441hz_0.01s_vbr_fraunhofer.mp3", duration: 0.01, },
        { name: "sine(441hz) 0.01s VBR(VBRI)", source: "ffmpeg_sine_441hz_0.01s_vbr_vbri_fraunhofer.mp3", duration: 0.01, },
        { name: "sine(441hz) 0.01s VBR(XING: Xing)", source: "ffmpeg_sine_441hz_0.01s_vbr_xing_libmp3lame.mp3", duration: 0.01, },
        // 0.1s sine wave
        { name: "sine(441hz) 0.1s CBR(no header)", source: "ffmpeg_sine_441hz_0.1s_cbr_fraunhofer.mp3", duration: 0.1, },
        { name: "sine(441hz) 0.1s CBR(XING: Info)", source: "ffmpeg_sine_441hz_0.1s_cbr_xing_libmp3lame.mp3", duration: 0.1, },
        { name: "sine(441hz) 0.1s VBR(no header)", source: "ffmpeg_sine_441hz_0.1s_vbr_fraunhofer.mp3", duration: 0.1, },
        { name: "sine(441hz) 0.1s VBR(VBRI)", source: "ffmpeg_sine_441hz_0.1s_vbr_vbri_fraunhofer.mp3", duration: 0.1, },
        { name: "sine(441hz) 0.1s VBR(XING: Xing)", source: "ffmpeg_sine_441hz_0.1s_vbr_xing_libmp3lame.mp3", duration: 0.1, },
        // 1s sine wave
        { name: "sine(441hz) 1s CBR(no header)", source: "ffmpeg_sine_441hz_1s_cbr_fraunhofer.mp3", duration: 1, },
        { name: "sine(441hz) 1s CBR(XING: Info)", source: "ffmpeg_sine_441hz_1s_cbr_xing_libmp3lame.mp3", duration: 1, },
        { name: "sine(441hz) 1s VBR(no header)", source: "ffmpeg_sine_441hz_1s_vbr_fraunhofer.mp3", duration: 1, },
        { name: "sine(441hz) 1s VBR(VBRI)", source: "ffmpeg_sine_441hz_1s_vbr_vbri_fraunhofer.mp3", duration: 1, },
        { name: "sine(441hz) 1s VBR(XING: Xing)", source: "ffmpeg_sine_441hz_1s_vbr_xing_libmp3lame.mp3", duration: 1, },
        // 10s sine wave
        { name: "sine(441hz) 10s CBR(no header)", source: "ffmpeg_sine_441hz_10s_cbr_fraunhofer.mp3", duration: 10, },
        { name: "sine(441hz) 10s CBR(XING: Info)", source: "ffmpeg_sine_441hz_10s_cbr_xing_libmp3lame.mp3", duration: 10, },
        { name: "sine(441hz) 10s VBR(no header)", source: "ffmpeg_sine_441hz_10s_vbr_fraunhofer.mp3", duration: 10, },
        { name: "sine(441hz) 10s VBR(VBRI)", source: "ffmpeg_sine_441hz_10s_vbr_vbri_fraunhofer.mp3", duration: 10, },
        { name: "sine(441hz) 10s VBR(XING: Xing)", source: "ffmpeg_sine_441hz_10s_vbr_xing_libmp3lame.mp3", duration: 10, },
      ],
    };

    var TOLERANCE = 0.01; // 1%

    function checkDuration(event) {
      let id = event.target.id;
      let name = event.target.name;
      let expect = event.target.getAttribute("expected-duration");
      let actual = event.target.duration;
      console.log(id + ": expect: " + expect + ", get: " + actual);
      if (expect == -1) {
        console.log("The is live stream. Ignore.");
        return;
      }
      let diff = Math.abs(actual - expect);
      let errorRate = diff / expect;
      console.log("Error rate: " + errorRate + ", Tolerance: " + TOLERANCE);
      console.assert(errorRate < TOLERANCE, id + ":" + name + " > Estimated duration is out of tolerance!");
    }

    function loadMedia() {
      MATRICES.MP3.forEach(function(data, index) {
        let id = "MP3-" + index;
        document.getElementById("tests").innerHTML += "<p>" + id + ":" + data.name + "</p>";

        let sound = document.createElement("audio");
        sound.id = id;
        sound.name = data.name;
        sound.src = data.source;
        sound.controls = 'controls';
        sound.setAttribute("expected-duration", data.duration);

        sound.addEventListener('durationchange', checkDuration);

        document.getElementById("tests").appendChild(sound);
      });
    }

    function playAll(event) {
      // Start playing all media
      let sounds = document.getElementById("tests").getElementsByTagName("audio");
      for (let i = 0 ; i < sounds.length ; ++i) {
        sounds[i].play();
      }
    }

    document.addEventListener("DOMContentLoaded", (event) => {
      // Init
      loadMedia();
      document.getElementById("run").addEventListener("click", playAll);
    });
  </script>
</head>
<body>
  <h1>Duration Test</h1>
  <p>Open console to see the verbose log and results.</p>
  <p>The mp3 files here are generated by <a target="_blank" href="https://github.com/ChunMinChang/raw2mp3">raw2mp3</a></p>
  <button id="run">Play all tracks</button>
  <div id="tests"></div>
</body>
</html>